---
import BaseLayout from '../../layouts/BaseLayout.astro';
---

<BaseLayout title="마이페이지">
  <section class="container-wide py-12 md:py-20">
    <!-- Auth Check -->
    <div id="auth-check" class="text-center py-20">
      <p class="text-secondary">로딩 중...</p>
    </div>

    <!-- Not Logged In -->
    <div id="not-logged-in" class="hidden text-center py-20">
      <h2 class="text-2xl font-serif font-bold text-primary mb-4">
        로그인이 필요합니다
      </h2>
      <p class="text-secondary mb-6">
        마이페이지를 이용하려면 로그인해주세요.
      </p>
      <a
        href="/auth/login"
        class="inline-block px-6 py-3 bg-primary text-white rounded-full font-medium hover:bg-accent transition-colors"
      >
        로그인하기
      </a>
    </div>

    <!-- Logged In Content -->
    <div id="logged-in-content" class="hidden">
      <!-- Header -->
      <div class="flex items-center justify-between mb-10">
        <div>
          <h1 class="text-3xl md:text-4xl font-serif font-bold text-primary mb-2">
            마이페이지
          </h1>
          <p class="text-secondary">
            안녕하세요, <span id="user-name" class="font-medium text-primary"></span>님!
          </p>
        </div>
        <div class="flex gap-3">
          <a
            href="/community/new"
            class="px-5 py-2.5 bg-accent text-white rounded-full font-medium hover:bg-accent/90 transition-colors"
          >
            새 글 작성
          </a>
          <button
            id="logout-btn"
            class="px-5 py-2.5 border border-gray-300 text-secondary rounded-full font-medium hover:bg-gray-50 transition-colors"
          >
            로그아웃
          </button>
        </div>
      </div>

      <!-- My Posts -->
      <div>
        <h2 class="text-xl font-bold text-primary mb-6">내가 작성한 글</h2>

        <div id="posts-loading" class="text-center py-10">
          <p class="text-secondary">불러오는 중...</p>
        </div>

        <div id="posts-empty" class="hidden text-center py-10 bg-gray-50 rounded-xl">
          <p class="text-secondary mb-4">아직 작성한 글이 없습니다.</p>
          <a href="/community/new" class="text-accent hover:underline">첫 번째 글을 작성해보세요!</a>
        </div>

        <div id="posts-list" class="hidden grid gap-4">
        </div>
      </div>
    </div>
  </section>
</BaseLayout>

<script>
  import { getUser, getMyPosts, signOut } from '../../lib/supabase';

  const authCheck = document.getElementById('auth-check');
  const notLoggedIn = document.getElementById('not-logged-in');
  const loggedInContent = document.getElementById('logged-in-content');
  const userName = document.getElementById('user-name');
  const postsLoading = document.getElementById('posts-loading');
  const postsEmpty = document.getElementById('posts-empty');
  const postsList = document.getElementById('posts-list');
  const logoutBtn = document.getElementById('logout-btn');

  async function init() {
    const user = await getUser();

    authCheck?.classList.add('hidden');

    if (!user) {
      notLoggedIn?.classList.remove('hidden');
      return;
    }

    loggedInContent?.classList.remove('hidden');
    if (userName) {
      userName.textContent = user.user_metadata?.name || user.email?.split('@')[0] || '사용자';
    }

    // Load posts
    const { data: posts, error } = await getMyPosts();
    postsLoading?.classList.add('hidden');

    if (!posts || posts.length === 0) {
      postsEmpty?.classList.remove('hidden');
      return;
    }

    postsList?.classList.remove('hidden');
    if (postsList) {
      postsList.innerHTML = posts.map(post => `
        <div class="p-6 bg-white border border-gray-200 rounded-xl">
          <div class="flex items-start justify-between mb-3">
            <h3 class="font-bold text-primary">${post.title}</h3>
            <span class="px-2 py-1 text-xs rounded-full ${
              post.status === 'approved' ? 'bg-green-100 text-green-700' :
              post.status === 'rejected' ? 'bg-red-100 text-red-700' :
              'bg-yellow-100 text-yellow-700'
            }">
              ${post.status === 'approved' ? '승인됨' : post.status === 'rejected' ? '거절됨' : '검토 중'}
            </span>
          </div>
          <p class="text-secondary text-sm line-clamp-2 mb-3">${post.content}</p>
          ${post.images && post.images.length > 0 ? `
            <div class="flex gap-2 mb-3">
              ${post.images.slice(0, 3).map(img => `
                <img src="${img}" alt="" class="w-16 h-16 object-cover rounded-lg" />
              `).join('')}
              ${post.images.length > 3 ? `<span class="text-secondary text-sm">+${post.images.length - 3}</span>` : ''}
            </div>
          ` : ''}
          <p class="text-xs text-gray-400">
            ${new Date(post.created_at).toLocaleDateString('ko-KR')}
          </p>
        </div>
      `).join('');
    }
  }

  logoutBtn?.addEventListener('click', async () => {
    await signOut();
    window.location.href = '/';
  });

  init();
</script>
