---
import BaseLayout from '../../layouts/BaseLayout.astro';
---

<BaseLayout title="커뮤니티" description="도시산책 커뮤니티에서 다양한 이야기를 만나보세요">
  <section class="container-wide py-12 md:py-20">
    <!-- Header -->
    <div class="flex items-end justify-between mb-10">
      <div>
        <h1 class="text-3xl md:text-4xl font-serif font-bold text-primary mb-2">
          커뮤니티
        </h1>
        <p class="text-secondary">도시산책러들의 이야기</p>
      </div>
      <a
        href="/community/new"
        id="write-btn"
        class="hidden px-5 py-2.5 bg-accent text-white rounded-full font-medium hover:bg-accent/90 transition-colors"
      >
        글쓰기
      </a>
    </div>

    <!-- Posts -->
    <div id="posts-loading" class="text-center py-20">
      <p class="text-secondary">불러오는 중...</p>
    </div>

    <div id="posts-empty" class="hidden text-center py-20">
      <p class="text-secondary text-lg mb-4">아직 게시글이 없습니다.</p>
      <a href="/community/new" class="text-accent hover:underline">첫 번째 글을 작성해보세요!</a>
    </div>

    <div id="posts-grid" class="hidden grid md:grid-cols-2 lg:grid-cols-3 gap-6">
    </div>
  </section>
</BaseLayout>

<script>
  import { getUser, getApprovedPosts } from '../../lib/supabase';

  const writeBtn = document.getElementById('write-btn');
  const postsLoading = document.getElementById('posts-loading');
  const postsEmpty = document.getElementById('posts-empty');
  const postsGrid = document.getElementById('posts-grid');

  async function init() {
    // Show write button if logged in
    const user = await getUser();
    if (user) {
      writeBtn?.classList.remove('hidden');
    }

    // Load posts
    const { data: posts, error } = await getApprovedPosts();
    postsLoading?.classList.add('hidden');

    if (!posts || posts.length === 0) {
      postsEmpty?.classList.remove('hidden');
      return;
    }

    postsGrid?.classList.remove('hidden');
    if (postsGrid) {
      postsGrid.innerHTML = posts.map(post => `
        <article class="group bg-white border border-gray-200 rounded-xl overflow-hidden hover:shadow-lg transition-shadow">
          ${post.images && post.images.length > 0 ? `
            <div class="aspect-[4/3] overflow-hidden">
              <img
                src="${post.images[0]}"
                alt="${post.title}"
                class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
              />
            </div>
          ` : `
            <div class="aspect-[4/3] bg-gray-100 flex items-center justify-center">
              <svg class="w-12 h-12 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
              </svg>
            </div>
          `}
          <div class="p-5">
            <h3 class="font-bold text-primary mb-2 line-clamp-1">${post.title}</h3>
            <p class="text-secondary text-sm line-clamp-2 mb-4">${post.content}</p>
            <div class="flex items-center justify-between text-xs text-gray-400">
              <span>${post.author?.name || '익명'}</span>
              <span>${new Date(post.created_at).toLocaleDateString('ko-KR')}</span>
            </div>
          </div>
        </article>
      `).join('');
    }
  }

  init();
</script>
