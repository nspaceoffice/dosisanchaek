---
import BaseLayout from '../../layouts/BaseLayout.astro';
---

<BaseLayout title="로그인">
  <section class="container-narrow py-16 md:py-24">
    <div class="max-w-md mx-auto">
      <h1 class="text-3xl font-serif font-bold text-primary text-center mb-8">
        로그인
      </h1>

      <div id="error-message" class="hidden mb-4 p-4 bg-red-50 border border-red-200 text-red-600 rounded-lg text-sm">
      </div>

      <form id="login-form" class="space-y-6">
        <div>
          <label for="email" class="block text-sm font-medium text-primary mb-2">
            이메일
          </label>
          <input
            type="email"
            id="email"
            name="email"
            required
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-accent/20 focus:border-accent outline-none transition-colors"
            placeholder="your@email.com"
          />
        </div>

        <div>
          <label for="password" class="block text-sm font-medium text-primary mb-2">
            비밀번호
          </label>
          <input
            type="password"
            id="password"
            name="password"
            required
            minlength="6"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-accent/20 focus:border-accent outline-none transition-colors"
            placeholder="••••••••"
          />
        </div>

        <button
          type="submit"
          id="submit-btn"
          class="w-full py-3 bg-primary text-white rounded-lg font-medium hover:bg-accent transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
        >
          로그인
        </button>
      </form>

      <p class="mt-6 text-center text-secondary">
        계정이 없으신가요?
        <a href="/auth/signup" class="text-accent hover:underline">회원가입</a>
      </p>
    </div>
  </section>
</BaseLayout>

<script>
  import { signIn } from '../../lib/supabase';

  const form = document.getElementById('login-form') as HTMLFormElement;
  const errorMessage = document.getElementById('error-message') as HTMLDivElement;
  const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    errorMessage.classList.add('hidden');
    submitBtn.disabled = true;
    submitBtn.textContent = '로그인 중...';

    const formData = new FormData(form);
    const email = formData.get('email') as string;
    const password = formData.get('password') as string;

    const { data, error } = await signIn(email, password);

    if (error) {
      errorMessage.textContent = error.message === 'Invalid login credentials'
        ? '이메일 또는 비밀번호가 올바르지 않습니다.'
        : error.message;
      errorMessage.classList.remove('hidden');
      submitBtn.disabled = false;
      submitBtn.textContent = '로그인';
      return;
    }

    // Redirect to mypage on success
    window.location.href = '/mypage';
  });
</script>
