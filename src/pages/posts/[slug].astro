---
import BaseLayout from '../../layouts/BaseLayout.astro';
import VideoEmbed from '../../components/VideoEmbed.astro';
import ImageGallery from '../../components/ImageGallery.astro';
import { getAllPosts, getPostBySlug, urlFor } from '../../lib/sanity';
import { PortableText } from 'astro-portabletext';

export async function getStaticPaths() {
  const posts = await getAllPosts();
  return posts.map((post) => ({
    params: { slug: post.slug.current },
  }));
}

const { slug } = Astro.params;
const post = await getPostBySlug(slug!);

if (!post) {
  return Astro.redirect('/404');
}

const formattedDate = new Date(post.publishedAt).toLocaleDateString('ko-KR', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});

const mainImageUrl = post.mainImage
  ? urlFor(post.mainImage).width(1920).height(1080).format('webp').url()
  : null;

const ogImageUrl = post.mainImage
  ? urlFor(post.mainImage).width(1200).height(630).format('jpg').url()
  : undefined;
---

<BaseLayout title={post.title} description={post.excerpt} image={ogImageUrl}>
  <article>
    <!-- Hero Image -->
    {mainImageUrl && (
      <div class="relative h-[50vh] md:h-[70vh] overflow-hidden">
        <img
          src={mainImageUrl}
          alt={post.title}
          class="image-cover"
        />
        <div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent" />
      </div>
    )}

    <!-- Article Header -->
    <header class="container-narrow -mt-32 relative z-10 mb-12">
      <div class="bg-background rounded-2xl p-8 md:p-12 shadow-xl">
        {post.category && (
          <a
            href={`/category/${post.category.slug.current}`}
            class="inline-block px-4 py-1.5 bg-accent text-white text-sm font-medium rounded-full mb-4 hover:bg-accent/90 transition-colors"
          >
            {post.category.title}
          </a>
        )}

        <h1 class="text-3xl md:text-5xl font-serif font-bold text-primary leading-tight mb-6 text-balance">
          {post.title}
        </h1>

        {post.excerpt && (
          <p class="text-lg text-secondary mb-6 leading-relaxed">
            {post.excerpt}
          </p>
        )}

        <div class="flex items-center gap-4 text-sm text-secondary">
          {post.author && (
            <div class="flex items-center gap-3">
              {post.author.image && (
                <img
                  src={urlFor(post.author.image).width(48).height(48).url()}
                  alt={post.author.name}
                  class="w-10 h-10 rounded-full object-cover"
                />
              )}
              <span class="font-medium text-primary">{post.author.name}</span>
            </div>
          )}
          <span class="text-gray-300">|</span>
          <time datetime={post.publishedAt}>{formattedDate}</time>
        </div>
      </div>
    </header>

    <!-- Article Body -->
    <div class="container-narrow">
      <!-- Video Embed -->
      {post.videoUrl && (
        <VideoEmbed url={post.videoUrl} title={post.title} />
      )}

      <!-- Content -->
      {post.body && (
        <div class="prose-article">
          <PortableText value={post.body} />
        </div>
      )}

      <!-- Gallery -->
      {post.gallery && post.gallery.length > 0 && (
        <ImageGallery images={post.gallery} />
      )}

      <!-- Tags -->
      {post.tags && post.tags.length > 0 && (
        <div class="mt-12 pt-8 border-t border-gray-200">
          <div class="flex flex-wrap gap-2">
            {post.tags.map((tag) => (
              <span class="px-3 py-1 bg-gray-100 text-secondary text-sm rounded-full">
                #{tag}
              </span>
            ))}
          </div>
        </div>
      )}

      <!-- Author Bio -->
      {post.author?.bio && (
        <div class="mt-12 p-6 bg-gray-50 rounded-xl">
          <div class="flex items-start gap-4">
            {post.author.image && (
              <img
                src={urlFor(post.author.image).width(80).height(80).url()}
                alt={post.author.name}
                class="w-16 h-16 rounded-full object-cover"
              />
            )}
            <div>
              <h3 class="font-bold text-primary mb-1">{post.author.name}</h3>
              <p class="text-secondary text-sm">{post.author.bio}</p>
            </div>
          </div>
        </div>
      )}
    </div>
  </article>

  <!-- Back to Posts -->
  <div class="container-narrow mt-16 mb-8">
    <a
      href="/posts"
      class="inline-flex items-center gap-2 text-secondary hover:text-primary transition-colors"
    >
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16l-4-4m0 0l4-4m-4 4h18" />
      </svg>
      목록으로 돌아가기
    </a>
  </div>
</BaseLayout>
